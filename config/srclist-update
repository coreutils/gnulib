#!/bin/sh
# $Id: srclist-update,v 1.11 2003-08-13 06:48:58 eggert Exp $
#
# Check for files in directory $1 being up to date, according to the
# list on stdin.  Don't actually make any changes, just show the diffs.
#
# Source `dirname $0`/srclistvars.sh first, if it exists.

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
# 02111-1307, USA.

# Written by Karl Berry.


if test -n "$1"; then
  cd "$1" || exit 1
fi

verbose=false
#chicken="echo (would)"

: ${TMPDIR=/tmp}
dsttmp=$TMPDIR/srclist.dst

mydir=`dirname $0`
test -r $mydir/srclistvars.sh && . $mydir/srclistvars.sh


# 
# $1 is input, output to stdout with gpl.
#
fixlicense() \
{
    sed '

  /^\([[:space:]]*#[[:space:]]*\)Th[ei][ s].* is free software/,/^[[:space:]]*#.*USA\./c\
#	This program is free software; you can redistribute it and/or modify\
#	it under the terms of the GNU General Public License as published by\
#	the Free Software Foundation; either version 2, or (at your option)\
#	any later version.\
#\
#	This program is distributed in the hope that it will be useful,\
#	but WITHOUT ANY WARRANTY; without even the implied warranty of\
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\
#	GNU General Public License for more details.\
#\
#	You should have received a copy of the GNU General Public License along\
#	with this program; if not, write to the Free Software Foundation,\
#	Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

  /Th[ei][ s].* is free software/,/USA\.  *\*\//c\
   This program is free software; you can redistribute it and/or modify\
   it under the terms of the GNU General Public License as published by\
   the Free Software Foundation; either version 2, or (at your option)\
   any later version.\
\
   This program is distributed in the hope that it will be useful,\
   but WITHOUT ANY WARRANTY; without even the implied warranty of\
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\
   GNU General Public License for more details.\
\
   You should have received a copy of the GNU General Public License along\
   with this program; if not, write to the Free Software Foundation,\
   Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
' $1
}



# sed command to remove lines containing $Id lines.
# Quote the $Id so that CVS does not expand it in this script.
remove_id_lines='/[$]Id:.*[$]/d'

# sed command to remove trailing blanks.
# Do not use [[:space:]] in this pattern, as that would kill formfeeds.
remove_trailing_blanks='s/[	 ][	 ]*$//'

# $1 is input file, $2 is output.
# Remove $Id lines, since they'll differ between source locations.
# If $options contains "gpl", change the license to be the standard
# GPL.  We use this for libc files, et al.
# Also, normalize white space simple-mindedly.
#
fixfile() \
{
  case " $options " in
  *' gpl '*)
    fixlicense $1;;
  *)
    cat $1;;
  esac \
  | unexpand \
  | sed "$remove_id_lines; $remove_trailing_blanks" >$2
}


# 
cat | while read src dst options; do
  #echo "src=$src, dst=$dst, options=$options" >&2
  case $src:$dst in
    *: ) continue;;    # skip lines without second element
    '#'* ) continue;;  # skip comment-only lines
  esac

  # Expand variables and make sure we have an input file.
  eval src=$src
  if test ! -r $src; then
    echo "$0: cannot read $src" >&2
    continue
  fi

  # Ignore subdirs in src dir.  E.g., if input spec is
  #   src/subdir/foo.c dst
  # then write destination file dst/foo.c.
  eval dst=$dst
  test -d $dst && dst=$dst/`basename $src`

  # Fix files in both src and dst, for the sake
  # of a clean comparison.
  srctmp=$TMPDIR/`basename $src`
  fixfile $src $srctmp
  test -r $dst && fixfile $dst $dsttmp

  if test ! -e $dst; then
    echo "## $srctmp $dst  # new"
    $chicken cp -p $srctmp $dst
  elif cmp -s $srctmp $dsttmp; then
    $verbose && echo "## $srctmp $dst  # unchanged"
  else
    echo "## $srctmp $dst  # changes"
    diff -C 2 $dst $srctmp
  fi
done

rm -f $dsttmp
